language: php

php:
  - '7.3'

services:
  - docker

env:
  - IFX_VERSION=12.10.FC12W1DE PDO_VERSION=1.3.3

sudo: true

before_install:
  # Update Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce

  # Create the Informix directory
  - mkdir /opt/informix

  # Run the Informix docker image
  - docker run -it --name informix -v /opt/ibm/informix:/opt/ibm/informix --privileged -p 9088:9088 \
    -e LICENSE=accept \
    -e DB_NAME=test \
    -e DB_LOCALE=en_us.utf8 \
    -e DBMONEY=Y4MD- \
    -e DBDELIMITER='|' \
    ibmcom/informix-developer-database:${IFX_VERSION}

  # Compile and enable the Informix PDO extension
  - export INFORMIXDIR=/opt/ibm/informix
  - mkdir pdo_informix
  - (cd pdo_informix/; wget https://pecl.php.net/get/PDO_INFORMIX-${PDO_VERSION}.tgz -O pdo_informix.tgz && tar -xvf pdo_informix.tgz --strip 1)
  - (cd pdo_informix/; phpize && ./configure --with-pdo-informix=${INFORMIXDIR} && make && sudo make install)
  - echo "extension=pdo_informix.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - php -m | grep -i pdo
  - php -r "echo phpversion('pdo_informixp');"

script:
  - php dbConnectionTest.php
