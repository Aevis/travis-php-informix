language: php

php:
  - '7.3'

services:
  - docker

env:
  - IFX_VERSION=12.10.FC12W1DE PDO_VERSION=1.3.3

sudo: true

before_install:
  # Update Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce

  # Create a named volume for the Informix installation
  # This provides host access to the required libraries for the PDO extension
  - docker volume create informix
  - export INFORMIXDIR=/var/lib/docker/volumes/informix

  # Run the Informix docker image
  - docker network create testnetwork
  - docker run -td --network=testnetwork --name ifx -v informix:/opt/ibm/informix --privileged -p 9088:9088 -e "LICENSE=accept" -e "DB_LOCALE=en_US.utf8" -e "CLIENT_LOCALE=en_US.utf8" -e "DBMONEY=Y4MD-" -e "DBDELIMITER='|'" ibmcom/informix-developer-database:${IFX_VERSION}

  # Use takis to wait until the Informix DB initialization has finished
  - docker run --network=testnetwork -e CHECK_PORT=27017 -e CHECK_HOST=ifx giorgos/takis

  # Add sbspace and create the test DB
  - docker exec -it ifx bash
  - touch "${INFORMIX_DATA_DIR}"/spaces/sbspace
  - chmod 660 "${INFORMIX_DATA_DIR}"/spaces/sbspace
  - onspaces -c -S sbspace -p "${INFORMIX_DATA_DIR}"/spaces/sbspace -o 0 -s 20000
  - echo "CREATE DATABASE test WITH BUFFERED LOG" | dbaccess > /dev/null 2>&1
  - exit

  # Compile and enable the Informix PDO extension
  - mkdir pdo_informix
  - (cd pdo_informix/; wget https://pecl.php.net/get/PDO_INFORMIX-${PDO_VERSION}.tgz -O pdo_informix.tgz && tar -xvf pdo_informix.tgz --strip 1)
  - (cd pdo_informix/; phpize && ./configure --with-pdo-informix=${INFORMIXDIR} && make && sudo make install)
  - echo "extension=pdo_informix.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - php -m | grep -i pdo
  - php -r "echo phpversion('pdo_informixp');"

script:
  - php dbConnectionTest.php
